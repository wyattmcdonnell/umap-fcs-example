---
title: "Running UMAP on flow cytometry data"
author: "Wyatt J. McDonnell"
date: "10/8/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

This is an example of what some flow cytometry data visualized using UMAP looks like. The data shown below are flow cytometry data generated as part of an upcoming paper from our group on lymphocytes in human adipose tissue, and will be released publicly at publication/after peer review is complete. 

```{r libs, results="hide", error=FALSE}
#Call some libraries
library(tidyverse) #plots
library(cowplot) #save some space
library(viridis) #pretty colors
library(umap) #older package but works fine in R for demo
library(flowStats) #read FCS files
library(tictoc) #benchmarking
```

## Data transformation, downsampling

As mentioned by others, it's important to transform cytometry data due to comps/spillover and negative values, etc. etc. Here's two simple functions to perform the biexponential/arsinch transformation, with a cofactor of 150, and a function for downsampling from the FCS file: 

```{r functions}
asinh_fun <- function(x, cofactor = 150){
  x = asinh(x / cofactor)
  return(x)
}

downsampled_df <- function(df, downsampling_factor = 10) {
  df[seq(from = 1, to = nrow(df), by = downsampling_factor),]
}
```

## Data import

In this example, I'm importing an FCS file with a few different markers via the `flowStats` package.

```{r data import}
import <- read.FCS('~/Dropbox (VUMC)/AT phenotype paper/FCS files/1101_adipose_015.fcs')
```

Next, we'll use some publicly available code to subset to our analyzed channels (containing `-A` in the column name, and removing `Time` so we don't get funky lines all over our plots), transform our data, and downsample to a smaller number of cells for analysis. 

```{r tidying and transformation and sampling}
#Tidy our data
import_tbl <- import %>%
     exprs %>%
     as.tibble %>%
     dplyr::select(contains("-A"), -Time)

#Apply the arcsinh transformation
import_tbl_biexp <- import_tbl %>%
  dplyr::mutate_all(funs(asinh_fun(x = .)))

#Downsample for the sake of speed and time
downsampled_data <- downsampled_df(df = import_tbl_biexp, downsampling_factor = 100)
```

Let's take a quick look to make sure everything looks sensible:
```{r checking}
colnames(downsampled_data)
```

Looks good! Before UMAP, we'll run a quick PCA, and then we're off to the races: 
```{r PCA and UMAP}
#Run PCA on downsampled cells
PCA <- prcomp(downsampled_data)

#Run UMAP!
tic('The R version of UMAP took this long to run on ~5300 cells')
import_umap <- umap(d = PCA$x[,1:5], min_dist = 0.99, n_neighbors = 150, random_state = 13246, verbose = TRUE)
toc()
```

Finally, some plots to go with our new analysis:
```{r plots}
plot.1 <- import_umap$layout %>%
    as.tibble %>%
    set_names(nm = c("UMAP1", "UMAP2")) %>%
    bind_cols(downsampled_data) %>%
    ggplot(aes(x = UMAP1, y = UMAP2, col = `SSC-A`)) +
    geom_point(size=0.3) +
    scale_color_viridis(option = "viridis") +
    labs(col = "SSC-A")

plot.2 <- import_umap$layout %>%
    as.tibble %>%
    set_names(nm = c("UMAP1", "UMAP2")) %>%
    bind_cols(downsampled_data) %>%
    ggplot(aes(x = UMAP1, y = UMAP2, col = `FSC-A`)) +
    geom_point(size=0.3) +
    scale_color_viridis(option = "viridis") +
    labs(col = "FSC-A")

plot.3 <- import_umap$layout %>%
    as.tibble %>%
    set_names(nm = c("UMAP1", "UMAP2")) %>%
    bind_cols(downsampled_data) %>%
    ggplot(aes(x = UMAP1, y = UMAP2, col = `APC-A`)) +
    geom_point(size=0.3) +
    scale_color_viridis(option = "viridis") +
    labs(col = "APC-A")

plot.4 <- import_umap$layout %>%
    as.tibble %>%
    set_names(nm = c("UMAP1", "UMAP2")) %>%
    bind_cols(downsampled_data) %>%
    ggplot(aes(x = UMAP1, y = UMAP2, col = `Alexa 700-A`)) +
    geom_point(size=0.3) +
    scale_color_viridis(option = "viridis") +
    labs(col = "Alexa 700-A")

plot.5 <- import_umap$layout %>%
    as.tibble %>%
    set_names(nm = c("UMAP1", "UMAP2")) %>%
    bind_cols(downsampled_data) %>%
    ggplot(aes(x = UMAP1, y = UMAP2, col = `FITC-A`)) +
    geom_point(size=0.3) +
    scale_color_viridis(option = "viridis") +
    labs(col = "FITC-A")

plot.6 <- import_umap$layout %>%
    as.tibble %>%
    set_names(nm = c("UMAP1", "UMAP2")) %>%
    bind_cols(downsampled_data) %>%
    ggplot(aes(x = UMAP1, y = UMAP2, col = `Pacific Blue-A`)) +
    geom_point(size=0.3) +
    scale_color_viridis(option = "viridis") +
    labs(col = "Pacific Blue-A")

plot.7 <- import_umap$layout %>%
    as.tibble %>%
    set_names(nm = c("UMAP1", "UMAP2")) %>%
    bind_cols(downsampled_data) %>%
    ggplot(aes(x = UMAP1, y = UMAP2, col = `PerCP-A`)) +
    geom_point(size=0.3) +
    scale_color_viridis(option = "viridis") +
    labs(col = "PerCP-A")

plot.8 <- import_umap$layout %>%
    as.tibble %>%
    set_names(nm = c("UMAP1", "UMAP2")) %>%
    bind_cols(downsampled_data) %>%
    ggplot(aes(x = UMAP1, y = UMAP2, col = `PE-A`)) +
    geom_point(size=0.3) +
    scale_color_viridis(option = "viridis") +
    labs(col = "PE-A")

plot.9 <- import_umap$layout %>%
    as.tibble %>%
    set_names(nm = c("UMAP1", "UMAP2")) %>%
    bind_cols(downsampled_data) %>%
    ggplot(aes(x = UMAP1, y = UMAP2, col = `PE-Texas Red-A`)) +
    geom_point(size=0.3) +
    scale_color_viridis(option = "viridis") +
    labs(col = "PE-Texas Red-A")

plot.10 <- import_umap$layout %>%
    as.tibble %>%
    set_names(nm = c("UMAP1", "UMAP2")) %>%
    bind_cols(downsampled_data) %>%
    ggplot(aes(x = UMAP1, y = UMAP2, col = `PE-Cy7-A`)) +
    geom_point(size=0.3) +
    scale_color_viridis(option = "viridis") +
    labs(col = "PE-Cy7-A")

plot.11 <- import_umap$layout %>%
    as.tibble %>%
    set_names(nm = c("UMAP1", "UMAP2")) %>%
    bind_cols(downsampled_data) %>%
    ggplot(aes(x = UMAP1, y = UMAP2, col = `Pacific Blue-A`)) +
    geom_point(size=0.3) +
    scale_color_viridis(option = "viridis") +
    labs(col = "Pacific Blue-A")

plot.12 <- import_umap$layout %>%
    as.tibble %>%
    set_names(nm = c("UMAP1", "UMAP2")) %>%
    bind_cols(downsampled_data) %>%
    ggplot(aes(x = UMAP1, y = UMAP2, col =  `APC-Cy7-A`)) +
    geom_point(size=0.3) +
    scale_color_viridis(option = "viridis") +
    labs(col = "APC-Cy7-A")

plot.13 <- import_umap$layout %>%
    as.tibble %>%
    set_names(nm = c("UMAP1", "UMAP2")) %>%
    bind_cols(downsampled_data) %>%
    ggplot(aes(x = UMAP1, y = UMAP2, col = `Qdot 655-A`)) +
    geom_point(size=0.3) +
    scale_color_viridis(option = "viridis") +
    labs(col = "Qdot 655-A")

plot.14 <- import_umap$layout %>%
    as.tibble %>%
    set_names(nm = c("UMAP1", "UMAP2")) %>%
    bind_cols(downsampled_data) %>%
    ggplot(aes(x = UMAP1, y = UMAP2, col = `Aqua-Viability-A`)) +
    geom_point(size=0.3) +
    scale_color_viridis(option = "viridis") +
    labs(col = "Aqua-Viability-A")

plot.15 <- import_umap$layout %>%
    as.tibble %>%
    set_names(nm = c("UMAP1", "UMAP2")) %>%
    bind_cols(downsampled_data) %>%
    ggplot(aes(x = UMAP1, y = UMAP2, col = `Alexa 700-A`)) +
    geom_point(size=0.3) +
    scale_color_viridis() +
    labs(col = "Alexa 700-A")

plot_grid(plot.1, plot.2, plot.3, plot.4)
plot_grid(plot.5, plot.6, plot.7, plot.8)
plot_grid(plot.9, plot.10, plot.11, plot.12)
plot_grid(plot.13, plot.14, plot.15)
```

